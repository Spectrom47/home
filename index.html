<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyChe0_K6bjkP_RkakgSf06o0BLGofX4stQ",
  authDomain: "spectrom-9b7ce.firebaseapp.com",
  projectId: "spectrom-9b7ce",
  storageBucket: "spectrom-9b7ce.appspot.com",
  messagingSenderId: "1022687085021",
  appId: "1:1022687085021:web:bf2caba43d913c23963634",
  measurementId: "G-DKSVJKXT00"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const messagesCol = collection(db, "chat_messages");
const usersCol = collection(db, "chat_users");

let username = null;
let userDocRef = null;
let chatBox = null;

// Initialize chat user
async function initChatUser() {
  do {
    username = prompt("Enter username (3-12 chars):", "Guest" + Math.floor(Math.random()*1000));
  } while(!username || username.length < 3 || username.length > 12);

  userDocRef = await addDoc(usersCol, { username, joinedAt: serverTimestamp() });
  
  setTimeout(async () => {
    if(userDocRef) await deleteDoc(doc(db, "chat_users", userDocRef.id));
  }, 10 * 60 * 1000);
}

// Create chat UI with close tab
function createChatUI() {
  if(chatBox) return; // Prevent duplicate boxes

  chatBox = document.createElement("div");
  chatBox.id = "chatBox";
  chatBox.style.position = "fixed";
  chatBox.style.bottom = "20px";
  chatBox.style.right = "20px";
  chatBox.style.width = "320px";
  chatBox.style.maxHeight = "450px";
  chatBox.style.background = "rgba(0,0,0,0.85)";
  chatBox.style.borderRadius = "14px";
  chatBox.style.display = "flex";
  chatBox.style.flexDirection = "column";
  chatBox.style.overflow = "hidden";
  chatBox.style.zIndex = 9999;
  chatBox.style.boxShadow = "0 6px 25px rgba(0,0,0,0.4)";

  // Header with close button
  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.padding = "6px 10px";
  header.style.background = "rgba(30,30,30,0.8)";
  header.style.color = "#fff";
  header.style.fontWeight = "600";

  const title = document.createElement("span");
  title.textContent = "Chat";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#fff";
  closeBtn.style.cursor = "pointer";
  closeBtn.addEventListener("click", () => {
    chatBox.remove();
    chatBox = null;
    toggleBtn.style.display = "flex";
  });

  header.appendChild(title);
  header.appendChild(closeBtn);
  chatBox.appendChild(header);

  // Messages container
  const messages = document.createElement("div");
  messages.id = "chatMessages";
  messages.style.flex = "1";
  messages.style.padding = "10px";
  messages.style.overflowY = "auto";
  messages.style.color = "#fff";
  messages.style.fontSize = "13px";
  messages.style.background = "rgba(0,0,0,0.6)";
  messages.style.borderBottom = "1px solid rgba(255,255,255,0.2)";

  // Users container
  const users = document.createElement("div");
  users.id = "userList";
  users.style.padding = "6px 10px";
  users.style.background = "rgba(30,30,30,0.6)";
  users.style.fontSize = "12px";
  users.style.color = "#fff";
  users.style.overflowY = "auto";
  users.style.maxHeight = "80px";
  users.style.borderBottom = "1px solid rgba(255,255,255,0.2)";

  // Input container
  const inputDiv = document.createElement("div");
  inputDiv.style.display = "flex";

  const input = document.createElement("input");
  input.id = "chatInput";
  input.type = "text";
  input.placeholder = "Type a message...";
  input.style.flex = "1";
  input.style.padding = "8px";
  input.style.border = "none";
  input.style.outline = "none";
  input.style.background = "rgba(255,255,255,0.05)";
  input.style.color = "#fff";

  const sendBtn = document.createElement("button");
  sendBtn.id = "chatSend";
  sendBtn.textContent = "Send";
  sendBtn.style.padding = "8px";
  sendBtn.style.background = "#60a5fa";
  sendBtn.style.border = "none";
  sendBtn.style.color = "#fff";
  sendBtn.style.cursor = "pointer";

  inputDiv.appendChild(input);
  inputDiv.appendChild(sendBtn);

  chatBox.appendChild(messages);
  chatBox.appendChild(users);
  chatBox.appendChild(inputDiv);
  document.body.appendChild(chatBox);

  // Send message logic
  sendBtn.addEventListener("click", async () => {
    const text = input.value.trim();
    if(!text) return;
    try {
      await addDoc(messagesCol, { username, message: text, timestamp: serverTimestamp() });
      input.value = "";
    } catch(e) { console.error("Send failed:", e); }
  });

  input.addEventListener("keydown", e => { if(e.key === "Enter") sendBtn.click(); });

  // Listen for messages
  const msgQuery = query(messagesCol, orderBy("timestamp", "asc"), limit(100));
  onSnapshot(msgQuery, snapshot => {
    messages.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      const time = data.timestamp?.toDate().toLocaleTimeString() || "";
      div.innerHTML = `<strong>${data.username}</strong> [${time}]: ${data.message}`;
      messages.appendChild(div);
    });
    messages.scrollTop = messages.scrollHeight;
  });

  // Listen for users
  onSnapshot(usersCol, snapshot => {
    users.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      const joined = data.joinedAt?.toDate().toLocaleTimeString() || "-";
      const div = document.createElement("div");
      div.textContent = `${data.username} (joined: ${joined})`;
      users.appendChild(div);
    });
  });
}

// Chat toggle bubble
const toggleBtn = document.getElementById("chatToggle");
toggleBtn.addEventListener("click", async () => {
  if(!username) await initChatUser();
  toggleBtn.style.display = "none";
  createChatUI();
});
</script>
