<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Widget Integration</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; color: #333; }
    header { background-color: #282c34; color: #fff; padding: 20px; text-align: center; }
    header h1 { margin: 0; }
    nav a { color: #61dafb; text-decoration: none; margin: 0 10px; }
    main { padding: 20px; }
    footer { background-color: #282c34; color: #fff; text-align: center; padding: 10px; }

    /* Chat widget styles */
    #chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: #ff9800;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #chat-container {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 350px;
      max-width: 90%;
      height: 70vh;
      max-height: 90%;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #chat-header {
      background-color: #333;
      color: #fff;
      padding: 10px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #close-chat {
      cursor: pointer;
      font-size: 18px;
    }
    #chat-body {
      display: flex;
      height: calc(100% - 40px);
    }
    #chat-left {
      width: 120px;
      background-color: #f9f9f9;
      border-right: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
    }
    #chat-left h3 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 5px;
    }
    #users-list {
      max-height: 90%;
      overflow-y: auto;
    }
    #chat-right {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .message {
      margin-bottom: 10px;
    }
    .message-user {
      font-weight: bold;
      margin-right: 5px;
    }
    #input-area {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #message-input {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 14px;
    }
    #message-input:focus { outline: none; }
    #send-button {
      border: none;
      background-color: #2196F3;
      color: white;
      padding: 0 15px;
      cursor: pointer;
      font-size: 14px;
    }
    #send-button:hover {
      background-color: #1976D2;
    }
  </style>
</head>
<body>

  <header>
    <h1>My Website</h1>
    <nav><a href="#">Home</a> | <a href="#">About</a> | <a href="#">Contact</a></nav>
  </header>

  <main>
    <section>
      <h2>Welcome</h2>
      <p>This is the main content of the site. Enjoy browsing!</p>
    </section>
    <section>
      <h2>About Us</h2>
      <p>We provide exceptional service to our customers. Feel free to chat with us if you have any questions.</p>
    </section>
  </main>

  <footer>
    <p>Â© 2025 My Website</p>
  </footer>

  <!-- Chat Toggle Button -->
  <button id="chat-toggle">&#x1F4AC;</button>

  <!-- Chat Widget Container -->
  <div id="chat-container">
    <div id="chat-header">
      Chat <span id="close-chat">&#x2715;</span>
    </div>
    <div id="chat-body">
      <div id="chat-left">
        <h3>Online (<span id="users-count">0</span>)</h3>
        <div id="users-list"></div>
      </div>
      <div id="chat-right">
        <div id="messages"></div>
        <div id="input-area">
          <input type="text" id="message-input" placeholder="Type a message..." />
          <button id="send-button">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase and Chat Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, doc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    // TODO: Replace with your Firebase project configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let user = null;
    let userName = null;
    let presenceDocRef = null;

    const chatToggle = document.getElementById('chat-toggle');
    const chatContainer = document.getElementById('chat-container');
    const closeChat = document.getElementById('close-chat');
    const usersList = document.getElementById('users-list');
    const usersCount = document.getElementById('users-count');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    // Open chat: sign in anonymously and add to presence list
    chatToggle.addEventListener('click', async () => {
      chatContainer.style.display = 'block';
      chatToggle.style.display = 'none';
      if (!user) {
        await signInAnonymously(auth);
        user = auth.currentUser;
        // Use a short display name for the anonymous user
        userName = 'User' + user.uid.substring(1, 6);
      }
      if (!presenceDocRef) {
        presenceDocRef = doc(db, 'onlineUsers', user.uid);
        await setDoc(presenceDocRef, { name: userName, timestamp: serverTimestamp() });
        // Automatically remove the user after 10 minutes
        setTimeout(async () => {
          await deleteDoc(presenceDocRef);
          presenceDocRef = null;
        }, 600000);
      }
    });

    // Close chat: hide widget and remove from presence list
    closeChat.addEventListener('click', async () => {
      chatContainer.style.display = 'none';
      chatToggle.style.display = 'block';
      if (presenceDocRef) {
        await deleteDoc(presenceDocRef);
        presenceDocRef = null;
      }
    });

    // Ensure user is removed if they close or reload the page
    window.addEventListener('beforeunload', async () => {
      if (presenceDocRef) {
        await deleteDoc(presenceDocRef);
      }
    });

    // Listen for updates to the online users list
    const onlineUsersRef = collection(db, 'onlineUsers');
    onSnapshot(onlineUsersRef, (snapshot) => {
      let listHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        listHTML += `<div>${data.name}</div>`;
      });
      usersList.innerHTML = listHTML;
      usersCount.textContent = snapshot.size;
    });

    // Listen for new chat messages (ordered by timestamp)
    const messagesQuery = query(collection(db, 'messages'), orderBy('timestamp'));
    onSnapshot(messagesQuery, (snapshot) => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          appendMessage(msg.name, msg.text);
        }
      });
    });

    // Send a new message to Firestore
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, 'messages'), {
        name: userName,
        text: text,
        timestamp: serverTimestamp()
      });
      messageInput.value = '';
    }

    // Helper to append a message to the chat display
    function appendMessage(name, text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message';
      msgDiv.innerHTML = '<span class="message-user">' + name + ':</span> ' + text;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
</body>
</html>
