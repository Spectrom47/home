<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SDK</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  body {
    display: flex;
    min-height: 100vh;
    flex-direction: column;
    color: #111;
    background: linear-gradient(120deg, rgba(15,23,42,0.95), rgba(30,58,138,0.9)),
                url('https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
    background-size: cover;
  }
  header { background: rgba(15,23,36,0.85); color: #fff; padding: 16px 20px; backdrop-filter: blur(6px); }
  .container { max-width: 1024px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .logo { font-weight: 700; letter-spacing: 0.6px; }
  nav ul { list-style: none; display: flex; gap: 8px; align-items: center; }
  nav a { display: inline-block; padding: 8px 12px; color: #d1d5db; text-decoration: none; border-radius: 8px; transition: all .15s ease; }
  nav a:hover { color: #fff; background: rgba(255,255,255,0.12); transform: translateY(-1px); }
  nav li.tab-active > a, nav a.tab-active { color: #0f1724; background: #60a5fa; box-shadow: 0 6px 18px rgba(96,165,250,0.3); }
  main { flex: 1; padding: 28px 20px; max-width: 1024px; margin: 40px auto; width: 100%; }
  section { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); backdrop-filter: blur(10px); color: #e5e7eb; margin-bottom: 32px; }
  section:last-of-type { margin-bottom: 0; }
  section h1, section h2, section h3 { color: #fff; }
  .row { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
  .card { flex: 1 1 200px; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.12); text-align: center; color: #f3f4f6; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all .25s ease; }
  .card:hover { background: rgba(255,255,255,0.18); transform: translateY(-3px); }
  .img-card { overflow: hidden; padding: 0; background: rgba(255,255,255,0.15); border-radius: 10px; }
  .img-card a { display: block; text-decoration: none; color: inherit; }
  .img-card img { display: block; width: 100%; height: 160px; object-fit: cover; border-radius: 10px 10px 0 0; }
  .img-card .caption { padding: 10px 12px; font-size: 14px; color: #e5e7eb; background: rgba(15,23,36,0.6); }
  .feature-btn { display: block; padding: 14px 10px; border-radius: 10px; background: rgba(96,165,250,0.9); color: #fff; text-decoration: none; font-weight: 600; box-shadow: 0 5px 18px rgba(96,165,250,0.4); transition: all 0.2s ease; }
  .feature-btn:hover { background: rgba(59,130,246,0.9); transform: translateY(-2px); }
  .skill-tag { display: inline-block; padding: 6px 14px; background: rgba(96, 165, 250, 0.15); color: #dbeafe; border-radius: 16px; font-size: 14px; font-weight: 500; border: 1px solid rgba(96, 165, 250, 0.3); }
  footer { padding: 14px 20px; text-align: center; font-size: 13px; color: #9ca3af; background: rgba(15,23,36,0.8); backdrop-filter: blur(4px); }
  @media (max-width: 560px) {
    .container { flex-direction: column; align-items: flex-start; gap: 12px; }
    nav ul { width: 100%; justify-content: space-between; }
    .img-card img { height: 120px; }
  }

  /* Chat toggle styling (kept simple) */
  #chatToggle { position:fixed; bottom:20px; right:20px; width:50px; height:50px; background:#60a5fa; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
  #chatToggle.locked { background: #94a3b8; cursor: default; opacity: 0.9; }

  /* Admin login modal (simple)wadwwad 3 */
  .admin-modal { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:10000; background: rgba(0,0,0,0.45); }
  .admin-card { background:#0f1724; color:#ffffffe8; border-radius:10px; padding:18px; min-width:320px; box-shadow:0 8px 30px rgba(0,0,0,0.5); }
  .admin-card input { width:100%; padding:8px; margin-top:8px; border-radius:6px; border:none; outline:none; background:rgba(255,255,255,0.06); color:#fff; }
  .admin-card button { margin-top:10px; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#60a5fa; color:#fff; }
  .admin-card .hint { font-size:12px; color:#cbd5e1; margin-top:8px; } 
</style>
</head>

<body>
<header>
  <div class="container">
    <div class="logo">SDK Community</div>
    <nav aria-label="Main navigation">
      <ul>
        <li><a href="index.html" class="tab">Home</a></li>
        <li><a href="projects.html" class="tab">Projects</a></li>
        <li><a href="staff_directory.html" class="tab">Discord Staff</a></li>
        <li><a href="contact.html" class="tab">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <section id="home">
    <h1>Home</h1>
    <p style="margin-top:8px;">Hosted By Spectrom</p>
    <div class="row" style="margin-top:14px;">
      <div class="card">
        <a class="feature-btn" href="https://www.roblox.com/share?code=a1abe7d356d1124cb26ce54463287004&type=ExperienceDetails&stamp=1763687339228" target="_blank" rel="noopener noreferrer" title="Soulspire (Roblox)">
          Soulspire (Roblox)
        </a>
      </div>
      <div class="card">
        <a class="feature-btn" href="https://www.fiverr.com/s/NN10LGN" target="_blank" rel="noopener noreferrer" title="Fiverr gig">
          Hire
        </a>
      </div>
      <div class="card">
        <a class="feature-btn" href="https://discord.gg/hxhmuDTNc4" target="_blank" rel="noopener noreferrer" title="Join our Discord">
          Discord
        </a>
      </div>
    </div>
  </section>

  <section id="intro-video" style="padding:0; overflow:hidden;">
    <video 
      style="width:100%; height:auto; display:block; border-radius:16px;"
      controls
      autoplay
      muted
      loop
      playsinline
    >
      <source src="images/KeepForWebsite.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </section>

  <section id="about">
    <h2>About</h2>
    <p style="margin-top:8px;">I'm a passionate developer and creator with a love for building immersive experiences. From game development on platforms like Roblox to web development, I enjoy bringing ideas to life with code and design.</p>
    <h3 style="margin-top: 20px;">My Skills</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px;">
      <span class="skill-tag">Python3 - Certifed</span>
      <span class="skill-tag">JavaScript</span>
      <span class="skill-tag">HTML & CSS</span>
      <span class="skill-tag">Static Web Design</span>
      <span class="skill-tag">Roblox Lua</span>
      <span class="skill-tag">Game Design</span>
      <span class="skill-tag">Firebase Database Systems</span>
      <span class="skill-tag">Node.js</span>
    </div>
  </section>

  <section id="recent">
    <h2>Recent Work</h2>
    <p style="margin-top:6px; color: #cbd5e1;">A quick showcase of recent images (image_one â†’ image_four).</p>
    <div class="row" style="margin-top:12px;">
      <div class="card img-card" style="flex:1 1 220px; max-width:240px;">
        <a href="images/image_one.png" target="_blank" rel="noopener noreferrer">
          <img src="images/image_one.png" alt="Recent work â€” image one">
          <div class="caption">image_one</div>
        </a>
      </div>
      <div class="card img-card" style="flex:1 1 220px; max-width:240px;">
        <a href="images/image_two.png" target="_blank" rel="noopener noreferrer">
          <img src="images/image_two.png" alt="Recent work â€” image two">
          <div class="caption">image_two</div>
        </a>
      </div>
      <div class="card img-card" style="flex:1 1 220px; max-width:240px;">
        <a href="images/image_three.png" target="_blank" rel="noopener noreferrer">
          <img src="images/image_three.png" alt="Recent work â€” image three">
          <div class="caption">image_three</div>
        </a>
      </div>
      <div class="card img-card" style="flex:1 1 220px; max-width:240px;">
        <a href="images/image_four.png" target="_blank" rel="noopener noreferrer">
          <img src="images/image_four.png" alt="Recent work â€” image four">
          <div class="caption">image_four</div>
        </a>
      </div>
    </div>
  </section>
</main>

<footer>
  &copy; 2025 MyWebsite â€” built with slightly too much coffee and curiosity.
</footer>

<!-- Chat Toggle Button -->
<div id="chatToggle" title="Admin-only chat (Shift+Q to open admin login)">
  <span style="color:#fff; font-size:20px; font-weight:bold;">ðŸ’¬</span>
</div>

<!-- Replace your previous module script with this updated one -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
  query, orderBy, limit, where, Timestamp, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

(() => {

  // --- ChatApp Module (nested submodules: Auth, Utils, Firestore, UI) ---
  const ChatApp = (function () {
    // private config
    const firebaseConfig = {
      apiKey: "AIzaSyChe0_K6bjkP_RkakgSf06o0BLGofX4stQ",
      authDomain: "spectrom-9b7ce.firebaseapp.com",
      projectId: "spectrom-9b7ce",
      storageBucket: "spectrom-9b7ce.appspot.com",
      messagingSenderId: "1022687085021",
      appId: "1:1022687085021:web:bf2caba43d913c23963634",
      measurementId: "G-DKSVJKXT00"
    };

    // ---------- Utils (nested helper functions) ----------
    const Utils = (function () {
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
      }
      function formatTime(ts) {
        try { return ts?.toDate().toLocaleTimeString() || ""; } catch(e) { return ""; }
      }
      return { escapeHtml, formatTime };
    })();

    // ---------- Auth (admin-only logic) ----------
    const Auth = (function () {
      let isAdmin = false;
      const ADMIN_CREDENTIALS = { user: "sdk", pass: "sdkinteractive2023" };

      function showLoginModal(onSuccess) {
        // create modal nodes
        const modal = document.createElement("div");
        modal.className = "admin-modal";
        modal.innerHTML = `
          <div class="admin-card" role="dialog" aria-modal="true">
            <div style="font-weight:700">Admin Login</div>
            <div class="hint">Press Shift+Q to open this. Use admin creds to enable chat.</div>
            <input id="adminUser" placeholder="User" value="" autocomplete="username"/>
            <input id="adminPass" placeholder="Password" type="password" autocomplete="current-password"/>
            <div style="display:flex; gap:8px;">
              <button id="adminSubmit">Sign in</button>
              <button id="adminCancel" style="background:#374151;">Cancel</button>
            </div>
            <div id="adminMsg" class="hint" style="margin-top:8px;"></div>
          </div>
        `;
        document.body.appendChild(modal);

        const userEl = modal.querySelector("#adminUser");
        const passEl = modal.querySelector("#adminPass");
        const submit = modal.querySelector("#adminSubmit");
        const cancel = modal.querySelector("#adminCancel");
        const msg = modal.querySelector("#adminMsg");
        userEl.focus();

        function cleanup() { modal.remove(); }

        submit.addEventListener("click", () => {
          const u = userEl.value.trim();
          const p = passEl.value;
          if (u === ADMIN_CREDENTIALS.user && p === ADMIN_CREDENTIALS.pass) {
            isAdmin = true;
            msg.textContent = "Welcome, admin.";
            setTimeout(() => { cleanup(); onSuccess?.(); }, 250);
          } else {
            msg.textContent = "Invalid credentials.";
          }
        });

        cancel.addEventListener("click", () => {
          cleanup();
        });

        // quick keyboard submit
        modal.addEventListener("keydown", e => {
          if (e.key === "Enter") submit.click();
          if (e.key === "Escape") cancel.click();
        });
      }

      function requireAdminThen(fn) {
        if (isAdmin) { fn(); return; }
        showLoginModal(() => { fn(); });
      }

      function checkAdmin() { return isAdmin; }

      return { requireAdminThen, checkAdmin, showLoginModal };
    })();

    // ---------- Firestore submodule (nested) ----------
    const Firestore = (function () {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const messagesCol = collection(db, "chat_messages");
      // exports
      return { db, messagesCol, get Timestamp() { return Timestamp; }, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit, where, getDocs };
    })();

    // ---------- UI submodule (nested, factory returns UI controller) ----------
    const UI = (function () {
      // constants
      const RECENT_WINDOW_MS = 90 * 1000;
      const RECENT_LIMIT = 200;
      const OLDER_PAGE_SIZE = 50;

      function createChatUIFactory(usernameRef) {
        // encapsulated UI variables
        let recentUnsub = null;
        let oldestTimestamp = null;
        let pendingNewCount = 0;
        let newMsgIndicatorEl = null;

        // create DOM structure (nested builder functions)
        function buildBox() {
          const box = document.createElement("div");
          box.id = "chatBox";
          Object.assign(box.style, {
            position: "fixed", bottom: "20px", right: "20px",
            width: "350px", maxHeight: "500px", background: "rgba(0,0,0,0.85)",
            borderRadius: "14px", display: "flex", flexDirection: "column",
            overflow: "hidden", fontFamily: "Arial", zIndex: 9999, boxShadow: "0 6px 25px rgba(0,0,0,0.4)"
          });
          // header
          const header = document.createElement("div");
          Object.assign(header.style, { background: "#1e1e1e", color: "#fff", padding: "6px 10px", display: "flex", justifyContent: "space-between", alignItems: "center" });
          header.innerHTML = `<span>Chat</span>`;
          const closeBtn = document.createElement("button"); closeBtn.textContent = "âœ–";
          Object.assign(closeBtn.style, { background:"none", border:"none", color:"#fff", cursor:"pointer" });
          header.appendChild(closeBtn);
          box.appendChild(header);

          // info
          const infoDiv = document.createElement("div");
          Object.assign(infoDiv.style, { display:"flex", justifyContent:"space-between", padding:"6px 10px", fontSize:"12px", color:"#fff", background:"rgba(30,30,30,0.6)" });
          const playerCountDiv = document.createElement("div"); playerCountDiv.textContent = "Messages: 0";
          const activeUsersDiv = document.createElement("div"); activeUsersDiv.textContent = "Active: 0";
          infoDiv.appendChild(playerCountDiv);
          infoDiv.appendChild(activeUsersDiv);
          box.appendChild(infoDiv);

          // load older
          const loadOlderBtn = document.createElement("button"); loadOlderBtn.textContent = "Load older messages";
          Object.assign(loadOlderBtn.style, { display: "none", width: "100%", padding: "8px", border: "none", background: "rgba(255,255,255,0.06)", color: "#e5e7eb", cursor: "pointer" });
          box.appendChild(loadOlderBtn);

          // messages
          const messages = document.createElement("div"); messages.id = "chatMessages";
          Object.assign(messages.style, { flex:"1", padding:"10px", overflowY:"auto", color:"#fff", fontSize:"13px", background:"rgba(0,0,0,0.6)" });
          box.appendChild(messages);

          // newMsgIndicator
          newMsgIndicatorEl = document.createElement("button");
          Object.assign(newMsgIndicatorEl.style, { display:"none", position:"fixed", right:"80px", bottom:"84px", zIndex:10000, padding:"6px 10px", borderRadius:"8px", border:"none", cursor:"pointer", background:"#60a5fa", color:"#fff", boxShadow:"0 6px 18px rgba(96,165,250,0.3)" });
          document.body.appendChild(newMsgIndicatorEl);

          // input area
          const inputDiv = document.createElement("div"); inputDiv.style.display="flex";
          const input = document.createElement("input"); input.id="chatInput"; input.type="text"; input.placeholder="Type a message...";
          Object.assign(input.style, { flex:"1", padding:"8px", border:"none", outline:"none", background:"rgba(255,255,255,0.05)", color:"#fff" });
          const sendBtn = document.createElement("button"); sendBtn.id="chatSend"; sendBtn.textContent="Send";
          Object.assign(sendBtn.style, { padding:"8px", background:"#60a5fa", border:"none", color:"#fff", cursor:"pointer" });
          inputDiv.appendChild(input); inputDiv.appendChild(sendBtn);
          box.appendChild(inputDiv);

          // wire some events
          loadOlderBtn.addEventListener("click", async () => {
            loadOlderBtn.disabled = true; loadOlderBtn.textContent = "Loading older messages...";
            await loadOlderMessages(messages);
            loadOlderBtn.textContent = "Load older messages"; loadOlderBtn.disabled = false;
          });

          messages.addEventListener("scroll", () => {
            if (messages.scrollTop <= 6) loadOlderBtn.style.display = "block"; else loadOlderBtn.style.display = "none";
            checkViewingLatest(messages, newMsgIndicatorEl);
          });

          newMsgIndicatorEl.addEventListener("click", () => { scrollToBottom(messages, newMsgIndicatorEl); });

          function checkViewingLatest(messagesEl, indicatorEl) {
            const viewingLatest = (messagesEl.scrollHeight - (messagesEl.scrollTop + messagesEl.clientHeight) <= 50);
            if (viewingLatest) { indicatorEl.style.display = "none"; pendingNewCount = 0; }
            return viewingLatest;
          }

          function scrollToBottom(messagesEl, indicatorEl) {
            messagesEl.scrollTop = messagesEl.scrollHeight;
            indicatorEl.style.display = "none";
            pendingNewCount = 0;
          }

          // helper to create message node
          function createMessageNode(data) {
            const div = document.createElement("div");
            div.dataset.ts = data.timestamp?.toMillis?.() ?? 0;
            const time = Utils.formatTime(data.timestamp);
            div.innerHTML = `<strong style="margin-right:6px">${Utils.escapeHtml(data.username)}</strong> <span style="opacity:.7; font-size:12px">[${time}]</span><div style="margin-top:4px">${Utils.escapeHtml(data.message)}</div>`;
            const ageMs = Date.now() - (data.timestamp?.toMillis?.() ?? 0);
            if (ageMs > RECENT_WINDOW_MS) { div.style.opacity = "0.6"; div.style.fontSize = "13px"; } else { div.style.opacity = "1"; }
            div.style.padding = "6px 0";
            return div;
          }

          // send message logic
          async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            try {
              await Firestore.addDoc(Firestore.messagesCol, { username: usernameRef(), message: text, timestamp: Firestore.serverTimestamp() });
              input.value = "";
            } catch (e) { console.error("Send failed:", e); }
          }

          sendBtn.addEventListener("click", sendMessage);
          input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

          // make close button use a custom event so outer code can destroy properly
          closeBtn.addEventListener("click", () => {
            // dispatch a destroy request that the outer controller will listen for
            box.dispatchEvent(new CustomEvent("requestDestroy"));
          });

          // public API for UI controller
          return {
            nodes: { box, messages, playerCountDiv, activeUsersDiv: null },
            elements: { messages, newIndicator: newMsgIndicatorEl, loadOlderBtn },
            createMessageNode,
            scrollToBottom: () => scrollToBottom(messages, newMsgIndicatorEl),
            prependMessages: (nodes) => {
              if (!nodes.length) return;
              const priorHeight = messages.scrollHeight;
              nodes.forEach(node => messages.insertBefore(node, messages.firstChild));
              const newHeight = messages.scrollHeight;
              messages.scrollTop = newHeight - priorHeight + messages.scrollTop;
            },
            replaceRecentMessages: (nodes) => {
              messages.innerHTML = "";
              nodes.forEach(n => messages.appendChild(n));
            },
            setNewIndicator: (count) => {
              if (count <= 0) { newMsgIndicatorEl.style.display = "none"; pendingNewCount = 0; }
              else { pendingNewCount = count; newMsgIndicatorEl.textContent = `${count} new message${count>1?"s":""} â€” show`; newMsgIndicatorEl.style.display = "block"; }
            }
          };
        } // buildBox

        // firestore listeners and pagination
        async function startListeningRecent(uiController) {
          if (recentUnsub) recentUnsub(); // cleanup if any
          const cutoff = Firestore.Timestamp.fromDate(new Date(Date.now() - RECENT_WINDOW_MS));
          const recentQuery = Firestore.query(Firestore.messagesCol, Firestore.where("timestamp", ">=", cutoff), Firestore.orderBy("timestamp", "asc"), Firestore.limit(RECENT_LIMIT));

          let lastSnapshotSize = 0;

          recentUnsub = Firestore.onSnapshot(recentQuery, snapshot => {
            const nodes = []; const usersSet = new Set();
            snapshot.forEach(doc => { const data = doc.data(); usersSet.add(data.username); nodes.push(uiController.createMessageNode(data)); });

            uiController.replaceRecentMessages(nodes);

            // update info (we don't keep direct refs to those info nodes in this factory; we'll update via DOM)
            const headerInfo = uiController.nodes.box.querySelectorAll("div")[1];
            if (headerInfo) {
              const playerCountDiv = headerInfo.children[0];
              const activeUsersDiv = headerInfo.children[1];
              if (playerCountDiv) playerCountDiv.textContent = `Messages: ${snapshot.size}`;
              if (activeUsersDiv) activeUsersDiv.textContent = `Active: ${usersSet.size}`;
            }

            // autoscroll or set new indicator
            const atBottom = (uiController.elements.messages.scrollHeight - (uiController.elements.messages.scrollTop + uiController.elements.messages.clientHeight) <= 50);
            if (atBottom) uiController.scrollToBottom();
            else {
              const newCount = snapshot.size - lastSnapshotSize;
              if (newCount > 0) uiController.setNewIndicator((pendingNewCount || 0) + newCount);
            }
            lastSnapshotSize = snapshot.size;

            // oldest timestamp for pagination
            if (snapshot.size > 0) {
              const firstDoc = snapshot.docs[0];
              if (firstDoc && firstDoc.data().timestamp) { if (!oldestTimestamp) oldestTimestamp = firstDoc.data().timestamp; }
            }
          }, err => console.error("Realtime listen failed:", err));
        }

        async function loadOlderMessages(messagesEl) {
          try {
            let tsForQuery = oldestTimestamp || Firestore.Timestamp.fromDate(new Date());
            const olderQuery = Firestore.query(Firestore.messagesCol, Firestore.where("timestamp", "<", tsForQuery), Firestore.orderBy("timestamp", "desc"), Firestore.limit(OLDER_PAGE_SIZE));
            const snap = await Firestore.getDocs(olderQuery);
            if (snap.empty) return;
            const loaded = [];
            snap.forEach(d => loaded.push(d.data()));
            loaded.reverse();
            const nodes = loaded.map(data => uiController.createMessageNode(data));
            uiController.prependMessages(nodes);
            const firstTs = loaded[0].timestamp;
            if (firstTs) oldestTimestamp = firstTs;
          } catch (e) { console.error("Loading older messages failed:", e); }
        }

        // UI controller instance
        const uiController = buildBox();

        // wire a destroy handler so UI close and outer close both call same cleanup
        function destroy() {
          try {
            if (recentUnsub) { recentUnsub(); recentUnsub = null; }
          } catch (e) { console.error("Error during unsubscribe:", e); }
          try {
            if (uiController.elements.newIndicator && uiController.elements.newIndicator.remove) uiController.elements.newIndicator.remove();
          } catch (e) { /* ignore */ }
          try {
            if (uiController.nodes.box && uiController.nodes.box.remove) uiController.nodes.box.remove();
          } catch (e) { /* ignore */ }
        }

        // allow external callers to listen for destroy requests (emitted by close button)
        uiController.nodes.box.addEventListener("requestDestroy", () => {
          destroy();
          // outer-level ChatApp will set chatInstance = null and restore toggle
          if (typeof onRequestDestroy === "function") onRequestDestroy();
        });

        // We'll expose a handler registration for outer context
        let onRequestDestroy = null;
        function onDestroyRequested(fn) { onRequestDestroy = fn; }

        return {
          uiController,
          startListeningRecent: () => startListeningRecent(uiController),
          loadOlderMessages: () => loadOlderMessages(uiController.elements.messages),
          destroy,
          onDestroyRequested
        };
      }

      return { createChatUIFactory, constants: { RECENT_WINDOW_MS, RECENT_LIMIT, OLDER_PAGE_SIZE } };
    })();

    // ---------- Public API of ChatApp (init, openChat, closeChat) ----------
    function init() {
      // attach keyboard listener for Shift+Q to open admin modal
      (function attachAdminHotkey() {
        document.addEventListener("keydown", e => {
          if ((e.key === "Q" || e.key === "q") && e.shiftKey) {
            Auth.showLoginModal(() => {
              document.getElementById("chatToggle").classList.remove("locked");
              // after login open
              openChatAsAdmin();
            });
          }
        });
      })();

      // chat toggle click behavior: locked until admin; clicking shows a small hint if locked
      const chatToggle = document.getElementById("chatToggle");
      chatToggle.addEventListener("click", () => {
        if (!Auth.checkAdmin()) {
          // visual hint (briefly)
          chatToggle.classList.add("locked");
          const prevTitle = chatToggle.title;
          chatToggle.title = "Admin-only chat â€” press Shift+Q to authenticate";
          setTimeout(() => { chatToggle.classList.remove("locked"); chatToggle.title = prevTitle; }, 1500);
          return;
        }
        // if already open, close; otherwise open
        if (chatInstance) closeChat();
        else openChatAsAdmin();
      });

      // initial locked look
      chatToggle.classList.add("locked");
    }

    // open the chat UI (admin-only)
    let chatInstance = null;
    function openChatAsAdmin() {
      if (chatInstance) return; // already open
      // grab username prompt (simple prompt for admin session)
      const username = prompt("Admin username to display in chat:", "Admin");
      const usernameRef = () => username || "Admin";

      const factory = UI.createChatUIFactory(usernameRef);
      // register destroy callback so we can restore toggle and clear chatInstance
      factory.onDestroyRequested(() => {
        chatInstance?.destroy?.();
        chatInstance = null;
        const t = document.getElementById("chatToggle");
        if (t) t.style.display = "flex";
      });

      // show UI
      document.getElementById("chatToggle").style.display = "none";
      document.body.appendChild(factory.uiController.nodes.box);
      factory.startListeningRecent();
      // small initial scroll
      setTimeout(() => factory.uiController.scrollToBottom(), 200);

      // expose a close method as part of chatInstance
      chatInstance = {
        factory,
        destroy: () => {
          try { factory.destroy(); } catch(e) { console.error(e); }
          chatInstance = null;
          const t = document.getElementById("chatToggle");
          if (t) t.style.display = "flex";
        }
      };
    }

    // close chat externally (used by toggle and other controls)
    function closeChat() {
      if (!chatInstance) return;
      try {
        chatInstance.destroy();
      } catch (e) {
        console.error("Error closing chat:", e);
      } finally {
        chatInstance = null;
        const t = document.getElementById("chatToggle");
        if (t) t.style.display = "flex";
      }
    }

    return { init };
  })();

  // initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => ChatApp.init());
  } else {
    ChatApp.init();
  }
})();
</script>


<script>
  // Highlight active tab (keeps your existing small script)
  (function () {
    const tabs = document.querySelectorAll('nav a.tab');
    const currentPath = window.location.pathname.split('/').pop() || 'index.html';
    tabs.forEach(tab => {
      if (tab.getAttribute('href') === currentPath) {
        tab.classList.add('tab-active');
        if (tab.parentElement) tab.parentElement.classList.add('tab-active');
      }
    });
  })();
</script>
</body>
</html>
