<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Home - Spectroms Kingdom</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,700;1,700&family=Inter:wght@300;400;600&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* Reset + base */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html,body { height: 100%; }
  body {
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    background:
      linear-gradient(180deg, #f7f6f3 0%, #efece6 100%),
      repeating-linear-gradient(0deg, rgba(0,0,0,0.02) 0 1px, transparent 1px 24px);
    color: #222;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding: 28px;
  }

  /* Jekyll-like site container */
  .site {
    max-width: 1100px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 240px 1fr;
    gap: 28px;
    align-items: start;
  }

  /* Header / masthead */
  header.site-header {
    grid-column: 1 / -1;
    background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.5));
    border: 1px solid rgba(30,30,30,0.06);
    padding: 18px 22px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 6px 18px rgba(30,30,30,0.04);
    backdrop-filter: blur(2px);
  }
  .site-title {
    font-family: "Merriweather", Georgia, serif;
    font-size: 22px;
    color: #0b1220;
    letter-spacing: 0.2px;
    font-weight: 700;
  }
  .site-tagline {
    font-size: 13px;
    color: #475569;
    margin-left: 12px;
    font-weight: 400;
  }
  .header-right { display:flex; gap:12px; align-items:center; }

  nav.site-nav ul { list-style:none; display:flex; gap:8px; }
  nav.site-nav a {
    text-decoration:none;
    padding:8px 12px;
    border-radius:6px;
    color:#334155;
    font-weight:600;
    font-size:14px;
    background:transparent;
    border:1px dashed transparent;
  }
  nav.site-nav a.tab-active {
    background:#111827;
    color:#fff;
    border:1px solid rgba(0,0,0,0.08);
  }

  /* Sidebar (Jekyll-ish widgets) */
  aside.sidebar {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    border: 1px solid rgba(20,20,20,0.04);
    box-shadow: 0 8px 30px rgba(23,23,23,0.03);
    min-height: 160px;
  }
  .about-title { font-family:"Merriweather", serif; font-weight:700; font-size:16px; color:#0b1220; margin-bottom:6px; }
  .about-body { color:#334155; font-size:14px; line-height:1.4; margin-bottom:12px; }
  .widget { margin-top:12px; }
  .recent-list { list-style:none; display:flex; flex-direction:column; gap:8px; }
  .recent-list a { text-decoration:none; color:#0b1220; font-weight:600; background:transparent; padding:6px 8px; border-radius:6px; }
  .meta-small { font-family: "Source Code Pro", monospace; font-size:12px; color:#64748b; background: #f1f5f9; padding:6px 8px; border-radius:6px; display:inline-block; margin-bottom:8px; }

  /* Content / posts */
  .content {
    min-height: 360px;
  }

  .hero {
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
    border-radius:10px;
    padding:18px;
    border: 1px solid rgba(20,20,20,0.04);
    margin-bottom:18px;
    box-shadow: 0 10px 30px rgba(20,20,20,0.04);
  }
  .hero .yaml {
    font-family: "Source Code Pro", monospace;
    background:#f8fafc;
    color:#334155;
    padding:10px;
    border-radius:6px;
    border:1px solid rgba(10,10,10,0.03);
    margin-bottom:12px;
    font-size:13px;
  }
  .hero h1 { font-family:"Merriweather", serif; font-size:26px; color:#0b1220; margin-bottom:8px; }
  .hero p { color:#334155; font-size:15px; line-height:1.5; }

  .posts {
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .post {
    background: #fff;
    border-radius:8px;
    padding:14px;
    border:1px solid rgba(20,20,20,0.04);
    display:flex;
    gap:14px;
    align-items:flex-start;
  }
  .post .thumb { width:140px; min-height:88px; background:#e6eefc; border-radius:6px; overflow:hidden; }
  .post img { width:100%; height:100%; object-fit:cover; display:block; }
  .post .post-body { flex:1; }
  .post h2 { font-family:"Merriweather", serif; font-size:18px; color:#0b1220; margin-bottom:6px; }
  .post .meta { font-family:"Source Code Pro", monospace; font-size:12px; color:#64748b; margin-bottom:8px; display:block; }
  .post p { color:#334155; font-size:14px; line-height:1.45; }

  .feature-btn { display:inline-block; margin-top:8px; padding:8px 10px; border-radius:6px; background:#0f1724; color:#fff; text-decoration:none; font-weight:600; }
  .feature-btn:hover { background:#111827; }

  /* Footer */
  footer.site-footer {
    grid-column: 1 / -1;
    margin-top:18px;
    text-align:center;
    font-size:13px;
    color:#475569;
  }

  /* Chat toggle + admin modal keep existing identifiers for scripts */
  #chatToggle { position:fixed; bottom:20px; right:20px; width:56px; height:56px; background:#0b1220; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer; z-index:9999; box-shadow:0 10px 30px rgba(2,6,23,0.25); color:#fff; font-size:20px; }
  #chatToggle.locked { background:#94a3b8; cursor:default; opacity:0.95; }
  .admin-modal { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:10000; background: rgba(0,0,0,0.45); }
  .admin-card { background:#ffffff; color:#0b1220; border-radius:10px; padding:18px; width:360px; box-shadow:0 8px 30px rgba(0,0,0,0.2); }
  .admin-card input { width:100%; padding:8px; margin-top:8px; border-radius:6px; border:1px solid #e6eef3; outline:none; background:#fff; color:#0b1220; }
  .admin-card button { margin-top:10px; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#0b1220; color:#fff; }
  .admin-card .hint { font-size:13px; color:#64748b; margin-top:8px; }

  /* Responsive */
  @media (max-width: 860px) {
    .site { grid-template-columns: 1fr; padding:0 10px; }
    aside.sidebar { order: 2; }
    .site-header { flex-direction:column; align-items:flex-start; gap:8px; }
  }
</style>
</head>
<body>
  <div class="site">
    <header class="site-header">
      <div style="display:flex; align-items:center;">
        <div class="site-title">Spectroms Kingdom</div>
        <div class="site-tagline">— my virtual resume & tinkering lab</div>
      </div>
      <div class="header-right">
        <nav class="site-nav" aria-label="Main navigation">
          <ul>
            <li><a href="index.html" class="tab">Home</a></li>
            <li><a href="projects.html" class="tab">Projects</a></li>
            <li><a href="contact.html" class="tab">Contact</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <aside class="sidebar" aria-label="Sidebar">
      <div class="about-title">About</div>
      <div class="about-body">A compact portfolio and lab for experiments — code, art, and small games. Built with a love for odd ideas and too much coffee.</div>

      <div class="widget">
        <div class="meta-small">layout: page • author: Spectrom</div>
        <div style="font-weight:700; color:#0b1220; margin-top:8px; margin-bottom:6px;">Recent</div>
        <ul class="recent-list">
          <li><a href="projects.html">Unhearted Evil (Roblox)</a></li>
          <li><a href="https://www.fiverr.com/s/NN10LGN" target="_blank" rel="noopener noreferrer">Fiverr Seller Page</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </div>
    </aside>

    <main class="content" role="main">
      <article class="hero" aria-labelledby="hero-title">
        <div class="yaml">---
title: "Home"
date: 2025-10-13
tags: [portfolio, experiment]
---</div>
        <h1 id="hero-title">Home Page</h1>
        <p>My Virtual Resume Of My Best Creations! Below: highlights and a recent work gallery styled with a classic Jekyll-ish look.</p>
      </article>

      <section class="posts" aria-label="Highlights">
        <div class="post">
          <div class="thumb">
            <img src="images/image_one.png" alt="Unhearted Evil thumbnail" onerror="this.style.background='#e6eefc'; this.src='';">
          </div>
          <div class="post-body">
            <span class="meta">project • 2024 • game</span>
            <h2>Unhearted Evil (Roblox)</h2>
            <p>A playable world built on Roblox — mechanics, atmosphere and progress systems. Click below to explore the game landing.</p>
            <a class="feature-btn" href="https://www.roblox.com/games/100059343815383/Unhearted-Evil-New" target="_blank" rel="noopener noreferrer">Open game</a>
          </div>
        </div>

        <div class="post">
          <div class="thumb">
            <img src="images/image_two.png" alt="Fiverr thumbnail" onerror="this.style.background='#fef3c7'; this.src='';">
          </div>
          <div class="post-body">
            <span class="meta">services • ongoing</span>
            <h2>Fiverr Seller Page</h2>
            <p>Design and small dev gigs offered. Portfolio examples and client work are shown on the seller page.</p>
            <a class="feature-btn" href="https://www.fiverr.com/s/NN10LGN" target="_blank" rel="noopener noreferrer">View gig</a>
          </div>
        </div>

        <div class="post">
          <div class="thumb">
            <img src="images/image_three.png" alt="Recent work 3" onerror="this.style.background='#eaeef6'; this.src='';">
          </div>
          <div class="post-body">
            <span class="meta">art • showcase</span>
            <h2>Recent work gallery</h2>
            <p>Selected visuals and mockups. Click the images in the recent work section to open full-size versions.</p>
            <a class="feature-btn" href="projects.html">See gallery</a>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">© 2025 Spectroms Kingdom — built with slightly too much coffee and curiosity.</footer>
  </div>

  <!-- Chat Toggle Button (keeps id used by scripts) -->
  <div id="chatToggle" title="Admin-only chat (Shift+Q to open admin login)">💬</div>

  <!-- Firebase + Chat module (unchanged logic; preserves admin flow and chat UI) -->
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
  query, orderBy, limit, where, Timestamp, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

(() => {

  // --- ChatApp Module (nested submodules: Auth, Utils, Firestore, UI) ---
  const ChatApp = (function () {
    // private config
    const firebaseConfig = {
      apiKey: "AIzaSyChe0_K6bjkP_RkakgSf06o0BLGofX4stQ",
      authDomain: "spectrom-9b7ce.firebaseapp.com",
      projectId: "spectrom-9b7ce",
      storageBucket: "spectrom-9b7ce.appspot.com",
      messagingSenderId: "1022687085021",
      appId: "1:1022687085021:web:bf2caba43d913c23963634",
      measurementId: "G-DKSVJKXT00"
    };

    // ---------- Utils (nested helper functions) ----------
    const Utils = (function () {
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
      }
      function formatTime(ts) {
        try { return ts?.toDate().toLocaleTimeString() || ""; } catch(e) { return ""; }
      }
      return { escapeHtml, formatTime };
    })();

    // ---------- Auth (admin-only logic) ----------
    const Auth = (function () {
      let isAdmin = false;
      const ADMIN_CREDENTIALS = { user: "sdk", pass: "sdkinteractive2023" };

      function showLoginModal(onSuccess) {
        // create modal nodes
        const modal = document.createElement("div");
        modal.className = "admin-modal";
        modal.innerHTML = `
          <div class="admin-card" role="dialog" aria-modal="true">
            <div style="font-weight:700">Admin Login</div>
            <div class="hint">Press Shift+Q to open this. Use admin creds to enable chat.</div>
            <input id="adminUser" placeholder="User" value="" autocomplete="username"/>
            <input id="adminPass" placeholder="Password" type="password" autocomplete="current-password"/>
            <div style="display:flex; gap:8px;">
              <button id="adminSubmit">Sign in</button>
              <button id="adminCancel" style="background:#94a3b8; color:#0b1220;">Cancel</button>
            </div>
            <div id="adminMsg" class="hint" style="margin-top:8px;"></div>
          </div>
        `;
        document.body.appendChild(modal);

        const userEl = modal.querySelector("#adminUser");
        const passEl = modal.querySelector("#adminPass");
        const submit = modal.querySelector("#adminSubmit");
        const cancel = modal.querySelector("#adminCancel");
        const msg = modal.querySelector("#adminMsg");
        userEl.focus();

        function cleanup() { modal.remove(); }

        submit.addEventListener("click", () => {
          const u = userEl.value.trim();
          const p = passEl.value;
          if (u === ADMIN_CREDENTIALS.user && p === ADMIN_CREDENTIALS.pass) {
            isAdmin = true;
            msg.textContent = "Welcome, admin.";
            setTimeout(() => { cleanup(); onSuccess?.(); }, 250);
          } else {
            msg.textContent = "Invalid credentials.";
          }
        });

        cancel.addEventListener("click", () => {
          cleanup();
        });

        // quick keyboard submit
        modal.addEventListener("keydown", e => {
          if (e.key === "Enter") submit.click();
          if (e.key === "Escape") cancel.click();
        });
      }

      function requireAdminThen(fn) {
        if (isAdmin) { fn(); return; }
        showLoginModal(() => { fn(); });
      }

      function checkAdmin() { return isAdmin; }

      return { requireAdminThen, checkAdmin, showLoginModal };
    })();

    // ---------- Firestore submodule (nested) ----------
    const Firestore = (function () {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const messagesCol = collection(db, "chat_messages");
      // exports
      return { db, messagesCol, get Timestamp() { return Timestamp; }, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit, where, getDocs };
    })();

    // ---------- UI submodule (nested, factory returns UI controller) ----------
    const UI = (function () {
      // constants
      const RECENT_WINDOW_MS = 90 * 1000;
      const RECENT_LIMIT = 200;
      const OLDER_PAGE_SIZE = 50;

      function createChatUIFactory(usernameRef) {
        // encapsulated UI variables
        let recentUnsub = null;
        let oldestTimestamp = null;
        let pendingNewCount = 0;
        let newMsgIndicatorEl = null;

        // create DOM structure (nested builder functions)
        function buildBox() {
          const box = document.createElement("div");
          box.id = "chatBox";
          Object.assign(box.style, {
            position: "fixed", bottom: "20px", right: "20px",
            width: "350px", maxHeight: "500px", background: "rgba(0,0,0,0.85)",
            borderRadius: "14px", display: "flex", flexDirection: "column",
            overflow: "hidden", fontFamily: "Arial", zIndex: 9999, boxShadow: "0 6px 25px rgba(0,0,0,0.4)"
          });
          // header
          const header = document.createElement("div");
          Object.assign(header.style, { background: "#1e1e1e", color: "#fff", padding: "6px 10px", display: "flex", justifyContent: "space-between", alignItems: "center" });
          header.innerHTML = `<span>Chat</span>`;
          const closeBtn = document.createElement("button"); closeBtn.textContent = "✖";
          Object.assign(closeBtn.style, { background:"none", border:"none", color:"#fff", cursor:"pointer" });
          header.appendChild(closeBtn);
          box.appendChild(header);

          // info
          const infoDiv = document.createElement("div");
          Object.assign(infoDiv.style, { display:"flex", justifyContent:"space-between", padding:"6px 10px", fontSize:"12px", color:"#fff", background:"rgba(30,30,30,0.6)" });
          const playerCountDiv = document.createElement("div"); playerCountDiv.textContent = "Messages: 0";
          const activeUsersDiv = document.createElement("div"); activeUsersDiv.textContent = "Active: 0";
          infoDiv.appendChild(playerCountDiv);
          infoDiv.appendChild(activeUsersDiv);
          box.appendChild(infoDiv);

          // load older
          const loadOlderBtn = document.createElement("button"); loadOlderBtn.textContent = "Load older messages";
          Object.assign(loadOlderBtn.style, { display: "none", width: "100%", padding: "8px", border: "none", background: "rgba(255,255,255,0.06)", color: "#e5e7eb", cursor: "pointer" });
          box.appendChild(loadOlderBtn);

          // messages
          const messages = document.createElement("div"); messages.id = "chatMessages";
          Object.assign(messages.style, { flex:"1", padding:"10px", overflowY:"auto", color:"#fff", fontSize:"13px", background:"rgba(0,0,0,0.6)" });
          box.appendChild(messages);

          // newMsgIndicator
          newMsgIndicatorEl = document.createElement("button");
          Object.assign(newMsgIndicatorEl.style, { display:"none", position:"fixed", right:"80px", bottom:"84px", zIndex:10000, padding:"6px 10px", borderRadius:"8px", border:"none", cursor:"pointer", background:"#60a5fa", color:"#fff", boxShadow:"0 6px 18px rgba(96,165,250,0.3)" });
          document.body.appendChild(newMsgIndicatorEl);

          // input area
          const inputDiv = document.createElement("div"); inputDiv.style.display="flex";
          const input = document.createElement("input"); input.id="chatInput"; input.type="text"; input.placeholder="Type a message...";
          Object.assign(input.style, { flex:"1", padding:"8px", border:"none", outline:"none", background:"rgba(255,255,255,0.05)", color:"#fff" });
          const sendBtn = document.createElement("button"); sendBtn.id="chatSend"; sendBtn.textContent="Send";
          Object.assign(sendBtn.style, { padding:"8px", background:"#60a5fa", border:"none", color:"#fff", cursor:"pointer" });
          inputDiv.appendChild(input); inputDiv.appendChild(sendBtn);
          box.appendChild(inputDiv);

          // wire some events
          loadOlderBtn.addEventListener("click", async () => {
            loadOlderBtn.disabled = true; loadOlderBtn.textContent = "Loading older messages...";
            await loadOlderMessages(messages);
            loadOlderBtn.textContent = "Load older messages"; loadOlderBtn.disabled = false;
          });

          messages.addEventListener("scroll", () => {
            if (messages.scrollTop <= 6) loadOlderBtn.style.display = "block"; else loadOlderBtn.style.display = "none";
            checkViewingLatest(messages, newMsgIndicatorEl);
          });

          newMsgIndicatorEl.addEventListener("click", () => { scrollToBottom(messages, newMsgIndicatorEl); });

          function checkViewingLatest(messagesEl, indicatorEl) {
            const viewingLatest = (messagesEl.scrollHeight - (messagesEl.scrollTop + messagesEl.clientHeight) <= 50);
            if (viewingLatest) { indicatorEl.style.display = "none"; pendingNewCount = 0; }
            return viewingLatest;
          }

          function scrollToBottom(messagesEl, indicatorEl) {
            messagesEl.scrollTop = messagesEl.scrollHeight;
            indicatorEl.style.display = "none";
            pendingNewCount = 0;
          }

          // helper to create message node
          function createMessageNode(data) {
            const div = document.createElement("div");
            div.dataset.ts = data.timestamp?.toMillis?.() ?? 0;
            const time = Utils.formatTime(data.timestamp);
            div.innerHTML = `<strong style="margin-right:6px">${Utils.escapeHtml(data.username)}</strong> <span style="opacity:.7; font-size:12px">[${time}]</span><div style="margin-top:4px">${Utils.escapeHtml(data.message)}</div>`;
            const ageMs = Date.now() - (data.timestamp?.toMillis?.() ?? 0);
            if (ageMs > RECENT_WINDOW_MS) { div.style.opacity = "0.6"; div.style.fontSize = "13px"; } else { div.style.opacity = "1"; }
            div.style.padding = "6px 0";
            return div;
          }

          // send message logic
          async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            try {
              await Firestore.addDoc(Firestore.messagesCol, { username: usernameRef(), message: text, timestamp: Firestore.serverTimestamp() });
              input.value = "";
            } catch (e) { console.error("Send failed:", e); }
          }

          sendBtn.addEventListener("click", sendMessage);
          input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

          // make close button use a custom event so outer code can destroy properly
          closeBtn.addEventListener("click", () => {
            // dispatch a destroy request that the outer controller will listen for
            box.dispatchEvent(new CustomEvent("requestDestroy"));
          });

          // public API for UI controller
          return {
            nodes: { box, messages, playerCountDiv, activeUsersDiv: null },
            elements: { messages, newMsgIndicator: newMsgIndicatorEl, loadOlderBtn },
            createMessageNode,
            scrollToBottom: () => scrollToBottom(messages, newMsgIndicatorEl),
            prependMessages: (nodes) => {
              if (!nodes.length) return;
              const priorHeight = messages.scrollHeight;
              nodes.forEach(node => messages.insertBefore(node, messages.firstChild));
              const newHeight = messages.scrollHeight;
              messages.scrollTop = newHeight - priorHeight + messages.scrollTop;
            },
            replaceRecentMessages: (nodes) => {
              messages.innerHTML = "";
              nodes.forEach(n => messages.appendChild(n));
            },
            setNewIndicator: (count) => {
              if (count <= 0) { newMsgIndicatorEl.style.display = "none"; pendingNewCount = 0; }
              else { pendingNewCount = count; newMsgIndicatorEl.textContent = `${count} new message${count>1?"s":""} — show`; newMsgIndicatorEl.style.display = "block"; }
            }
          };
        } // buildBox

        // firestore listeners and pagination
        async function startListeningRecent(uiController) {
          if (recentUnsub) recentUnsub(); // cleanup if any
          const cutoff = Firestore.Timestamp.fromDate(new Date(Date.now() - RECENT_WINDOW_MS));
          const recentQuery = Firestore.query(Firestore.messagesCol, Firestore.where("timestamp", ">=", cutoff), Firestore.orderBy("timestamp", "asc"), Firestore.limit(RECENT_LIMIT));

          let lastSnapshotSize = 0;

          recentUnsub = Firestore.onSnapshot(recentQuery, snapshot => {
            const nodes = []; const usersSet = new Set();
            snapshot.forEach(doc => { const data = doc.data(); usersSet.add(data.username); nodes.push(uiController.createMessageNode(data)); });

            uiController.replaceRecentMessages(nodes);

            // update info (we don't keep direct refs to those info nodes in this factory; we'll update via DOM)
            const headerInfo = uiController.nodes.box.querySelectorAll("div")[1];
            if (headerInfo) {
              const playerCountDiv = headerInfo.children[0];
              const activeUsersDiv = headerInfo.children[1];
              if (playerCountDiv) playerCountDiv.textContent = `Messages: ${snapshot.size}`;
              if (activeUsersDiv) activeUsersDiv.textContent = `Active: ${usersSet.size}`;
            }

            // autoscroll or set new indicator
            const atBottom = (uiController.elements.messages.scrollHeight - (uiController.elements.messages.scrollTop + uiController.elements.messages.clientHeight) <= 50);
            if (atBottom) uiController.scrollToBottom();
            else {
              const newCount = snapshot.size - lastSnapshotSize;
              if (newCount > 0) uiController.setNewIndicator((pendingNewCount || 0) + newCount);
            }
            lastSnapshotSize = snapshot.size;

            // oldest timestamp for pagination
            if (snapshot.size > 0) {
              const firstDoc = snapshot.docs[0];
              if (firstDoc && firstDoc.data().timestamp) { if (!oldestTimestamp) oldestTimestamp = firstDoc.data().timestamp; }
            }
          }, err => console.error("Realtime listen failed:", err));
        }

        async function loadOlderMessages(messagesEl) {
          try {
            let tsForQuery = oldestTimestamp || Firestore.Timestamp.fromDate(new Date());
            const olderQuery = Firestore.query(Firestore.messagesCol, Firestore.where("timestamp", "<", tsForQuery), Firestore.orderBy("timestamp", "desc"), Firestore.limit(OLDER_PAGE_SIZE));
            const snap = await Firestore.getDocs(olderQuery);
            if (snap.empty) return;
            const loaded = [];
            snap.forEach(d => loaded.push(d.data()));
            loaded.reverse();
            const nodes = loaded.map(data => uiController.createMessageNode(data));
            uiController.prependMessages(nodes);
            const firstTs = loaded[0].timestamp;
            if (firstTs) oldestTimestamp = firstTs;
          } catch (e) { console.error("Loading older messages failed:", e); }
        }

        // UI controller instance
        const uiController = buildBox();

        // wire a destroy handler so UI close and outer close both call same cleanup
        function destroy() {
          try {
            if (recentUnsub) { recentUnsub(); recentUnsub = null; }
          } catch (e) { console.error("Error during unsubscribe:", e); }
          try {
            if (uiController.elements.newMsgIndicator && uiController.elements.newMsgIndicator.remove) uiController.elements.newMsgIndicator.remove();
          } catch (e) { /* ignore */ }
          try {
            if (uiController.nodes.box && uiController.nodes.box.remove) uiController.nodes.box.remove();
          } catch (e) { /* ignore */ }
        }

        // allow external callers to listen for destroy requests (emitted by close button)
        uiController.nodes.box.addEventListener("requestDestroy", () => {
          destroy();
          // outer-level ChatApp will set chatInstance = null and restore toggle
          if (typeof onRequestDestroy === "function") onRequestDestroy();
        });

        // We'll expose a handler registration for outer context
        let onRequestDestroy = null;
        function onDestroyRequested(fn) { onRequestDestroy = fn; }

        return {
          uiController,
          startListeningRecent: () => startListeningRecent(uiController),
          loadOlderMessages: () => loadOlderMessages(uiController.elements.messages),
          destroy,
          onDestroyRequested
        };
      }

      return { createChatUIFactory, constants: { RECENT_WINDOW_MS, RECENT_LIMIT, OLDER_PAGE_SIZE } };
    })();

    // ---------- Public API of ChatApp (init, openChat, closeChat) ----------
    function init() {
      // attach keyboard listener for Shift+Q to open admin modal
      (function attachAdminHotkey() {
        document.addEventListener("keydown", e => {
          if ((e.key === "Q" || e.key === "q") && e.shiftKey) {
            Auth.showLoginModal(() => {
              document.getElementById("chatToggle").classList.remove("locked");
              // after login open
              openChatAsAdmin();
            });
          }
        });
      })();

      // chat toggle click behavior: locked until admin; clicking shows a small hint if locked
      const chatToggle = document.getElementById("chatToggle");
      chatToggle.addEventListener("click", () => {
        if (!Auth.checkAdmin()) {
          // visual hint (briefly)
          chatToggle.classList.add("locked");
          const prevTitle = chatToggle.title;
          chatToggle.title = "Admin-only chat — press Shift+Q to authenticate";
          setTimeout(() => { chatToggle.classList.remove("locked"); chatToggle.title = prevTitle; }, 1500);
          return;
        }
        // if already open, close; otherwise open
        if (chatInstance) closeChat();
        else openChatAsAdmin();
      });

      // initial locked look
      chatToggle.classList.add("locked");
    }

    // open the chat UI (admin-only)
    let chatInstance = null;
    function openChatAsAdmin() {
      if (chatInstance) return; // already open
      // grab username prompt (simple prompt for admin session)
      const username = prompt("Admin username to display in chat:", "Admin");
      const usernameRef = () => username || "Admin";

      const factory = UI.createChatUIFactory(usernameRef);
      // register destroy callback so we can restore toggle and clear chatInstance
      factory.onDestroyRequested(() => {
        chatInstance?.destroy?.();
        chatInstance = null;
        const t = document.getElementById("chatToggle");
        if (t) t.style.display = "flex";
      });

      // show UI
      document.getElementById("chatToggle").style.display = "none";
      document.body.appendChild(factory.uiController.nodes.box);
      factory.startListeningRecent();
      // small initial scroll
      setTimeout(() => factory.uiController.scrollToBottom(), 200);

      // expose a close method as part of chatInstance
      chatInstance = {
        factory,
        destroy: () => {
          try { factory.destroy(); } catch(e) { console.error(e); }
          chatInstance = null;
          const t = document.getElementById("chatToggle");
          if (t) t.style.display = "flex";
        }
      };
    }

    // close chat externally (used by toggle and other controls)
    function closeChat() {
      if (!chatInstance) return;
      try {
        chatInstance.destroy();
      } catch (e) {
        console.error("Error closing chat:", e);
      } finally {
        chatInstance = null;
        const t = document.getElementById("chatToggle");
        if (t) t.style.display = "flex";
      }
    }

    return { init };
  })();

  // initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => ChatApp.init());
  } else {
    ChatApp.init();
  }
})();
</script>

<script>
  // Highlight active tab (keeps your existing small script)
  (function () {
    const tabs = document.querySelectorAll('nav a.tab');
    const currentPath = window.location.pathname.split('/').pop();
    tabs.forEach(tab => {
      if (tab.getAttribute('href') === currentPath) {
        tab.classList.add('tab-active');
        if (tab.parentElement) tab.parentElement.classList.add('tab-active');
      }
    });
  })();
</script>
</body>
</html>
