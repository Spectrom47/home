<!-- Chat Box -->
<div id="chatToggle" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; background:#60a5fa; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
  <span style="color:#fff; font-size:20px; font-weight:bold;">ðŸ’¬</span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyChe0_K6bjkP_RkakgSf06o0BLGofX4stQ",
  authDomain: "spectrom-9b7ce.firebaseapp.com",
  projectId: "spectrom-9b7ce",
  storageBucket: "spectrom-9b7ce.appspot.com",
  messagingSenderId: "1022687085021",
  appId: "1:1022687085021:web:bf2caba43d913c23963634",
  measurementId: "G-DKSVJKXT00"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const chatCol = collection(db, "chat"); // <-- Firestore chat collection

let username = null;

// Prompt for username
function initChatUser() {
  do {
    username = prompt("Enter username (3-12 chars):", "Guest" + Math.floor(Math.random()*1000));
  } while(!username || username.length < 3 || username.length > 12);
}

// Create chat UI
function createChatUI() {
  const box = document.createElement("div");
  box.id = "chatBox";
  box.style.position = "fixed";
  box.style.bottom = "20px";
  box.style.right = "20px";
  box.style.width = "300px";
  box.style.maxHeight = "400px";
  box.style.background = "rgba(0,0,0,0.8)";
  box.style.borderRadius = "12px";
  box.style.display = "flex";
  box.style.flexDirection = "column";
  box.style.overflow = "hidden";
  box.style.fontFamily = "Arial";
  box.style.zIndex = 9999;
  box.style.boxShadow = "0 6px 20px rgba(0,0,0,0.4)";

  // Messages container
  const messages = document.createElement("div");
  messages.id = "chatMessages";
  messages.style.flex = "1";
  messages.style.padding = "10px";
  messages.style.overflowY = "auto";
  messages.style.color = "#fff";
  messages.style.fontSize = "13px";
  messages.style.background = "rgba(0,0,0,0.6)";

  // Input container
  const inputDiv = document.createElement("div");
  inputDiv.style.display = "flex";
  inputDiv.style.borderTop = "1px solid rgba(255,255,255,0.2)";

  const input = document.createElement("input");
  input.id = "chatInput";
  input.type = "text";
  input.placeholder = "Type a message...";
  input.style.flex = "1";
  input.style.padding = "8px";
  input.style.border = "none";
  input.style.outline = "none";
  input.style.background = "rgba(255,255,255,0.05)";
  input.style.color = "#fff";

  const sendBtn = document.createElement("button");
  sendBtn.id = "chatSend";
  sendBtn.textContent = "Send";
  sendBtn.style.padding = "8px";
  sendBtn.style.background = "#60a5fa";
  sendBtn.style.border = "none";
  sendBtn.style.color = "#fff";
  sendBtn.style.cursor = "pointer";

  inputDiv.appendChild(input);
  inputDiv.appendChild(sendBtn);
  box.appendChild(messages);
  box.appendChild(inputDiv);
  document.body.appendChild(box);

  // Send message
  sendBtn.addEventListener("click", async () => {
    const text = input.value.trim();
    if (!text) return;
    await addDoc(chatCol, { username, text, timestamp: serverTimestamp() });
    input.value = "";
  });

  input.addEventListener("keydown", e => {
    if(e.key === "Enter") sendBtn.click();
  });

  // Listen for new messages
  const q = query(chatCol, orderBy("timestamp", "asc"));
  onSnapshot(q, snapshot => {
    messages.innerHTML = ""; // Clear before re-render
    snapshot.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement("div");
      div.style.marginBottom = "6px";
      div.innerHTML = `<strong>${msg.username}</strong>: ${msg.text}`;
      messages.appendChild(div);
    });
    messages.scrollTop = messages.scrollHeight;
  });
}

// Toggle chat
const toggleBtn = document.getElementById("chatToggle");
toggleBtn.addEventListener("click", () => {
  if(!username) initChatUser();
  toggleBtn.style.display = "none";
  createChatUI();
});
</script>
