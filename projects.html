<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Projects - MyWebsite</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header> ... </header>
  <main> ... </main>
  <footer> ... </footer>

  <!-- Modals: dayModal, requestModal, adminModal, requestViewModal -->
  <div id="dayModal" class="modal-backdrop"> ... </div>
  <div id="requestModal" class="modal-backdrop"> ... </div>
  <div id="adminModal" class="modal-backdrop"> ... </div>
  <div id="requestViewModal" class="modal-backdrop"> ... </div>
  <div id="mailboxPanel" class="panel"> ... </div>

  <!-- Firebase SDK (compat) -->
  <script type="module" src="firebase.js"></script>

  <script type="module">
  import { addEvent, loadEvents, deleteEvent, addRequest, loadRequests, resolveRequest, onEventsChange, onRequestsChange } from './firebase.js';

  (function() {
    let isAdmin = false;
    let currentYear, currentMonth;
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let selectedDateISO = null;
    let selectedRequestId = null;

    // DOM refs
    const calendarGrid = document.getElementById('calendarGrid');
    const monthLabel = document.getElementById('monthLabel');
    const timelineList = document.getElementById('timelineList');
    const dayModal = document.getElementById('dayModal');
    const dayEventsContainer = document.getElementById('dayEventsContainer');
    const evtTitle = document.getElementById('evtTitle');
    const evtStart = document.getElementById('evtStart');
    const evtEnd = document.getElementById('evtEnd');
    const evtDesc = document.getElementById('evtDesc');
    const saveEvtBtn = document.getElementById('saveEvtBtn');
    const openRequestBtn = document.getElementById('openRequestBtn');
    const requestModal = document.getElementById('requestModal');
    const reqType = document.getElementById('reqType');
    const reqDate = document.getElementById('reqDate');
    const reqMessage = document.getElementById('reqMessage');
    const sendRequestBtn = document.getElementById('sendRequestBtn');
    const closeRequestModal = document.getElementById('closeRequestModal');
    const mailboxPanel = document.getElementById('mailboxPanel');
    const mailList = document.getElementById('mailList');
    const requestViewModal = document.getElementById('requestViewModal');
    const requestViewBody = document.getElementById('requestViewBody');
    const markResolvedBtn = document.getElementById('markResolvedBtn');

    const ADMIN_USER = 'sdk';
    const ADMIN_PASS = 'sdkinteractive2023';

    // Utilities
    const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const formatDayLabel = iso => new Date(iso+'T00:00:00').toLocaleDateString(undefined,{ weekday:'short', month:'short', day:'numeric' });

    // ---------- Calendar Render ----------
    async function renderCalendar(year, month) {
      calendarGrid.innerHTML = '';
      for(let i=0;i<7;i++){
        const dn = document.createElement('div');
        dn.className='day-name';
        dn.textContent = dayNames[i];
        calendarGrid.appendChild(dn);
      }
      const first = new Date(year, month, 1);
      const firstWeekday = first.getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      for(let i=0;i<firstWeekday;i++){
        const blank = document.createElement('div'); blank.className='date-cell'; blank.style.opacity=0.2; calendarGrid.appendChild(blank);
      }
      const allEvents = await loadEvents();
      const allRequests = await loadRequests();
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(year, month, d); const iso = toISO(date);
        const cell = document.createElement('div'); cell.className='date-cell'; cell.dataset.iso = iso;
        const top = document.createElement('div'); top.className='date-top';
        const num = document.createElement('div'); num.className='date-num'; num.textContent = d; top.appendChild(num);
        const evts = allEvents.filter(e=>e.dateISO===iso);
        const reqs = allRequests.filter(r=>r.dateISO===iso && r.status==='open');
        if(evts.length){ const b = document.createElement('div'); b.className='badge'; b.textContent=`${evts.length} event${evts.length>1?'s':''}`; top.appendChild(b);}
        else{ const spacer=document.createElement('div'); spacer.style.minWidth='34px'; top.appendChild(spacer);}
        if(reqs.length){ const rb=document.createElement('div'); rb.className='requests-badge'; rb.textContent=`${reqs.length} request${reqs.length>1?'s':''}`; top.appendChild(rb);}
        cell.appendChild(top);
        const list = document.createElement('div'); list.className='events-list';
        evts.forEach(e=>{ const eDiv=document.createElement('div'); eDiv.className='evt'; eDiv.textContent = e.title||'(untitled)'; list.appendChild(eDiv); });
        cell.appendChild(list);
        cell.addEventListener('click', ()=> openDayModal(iso));
        calendarGrid.appendChild(cell);
      }
      monthLabel.textContent = new Date(year, month).toLocaleDateString(undefined,{month:'long', year:'numeric'});
    }

    async function openDayModal(iso){
      selectedDateISO = iso;
      dayModal.style.display = 'flex';
    }

    // ---------- Event save/delete ----------
    saveEvtBtn.addEventListener('click', async ()=>{
      if(!isAdmin) return alert('Admin only');
      const title = evtTitle.value.trim(); const start=evtStart.value; const end=evtEnd.value;
      if(!title || !start){ alert('Title/start required'); return; }
      await addEvent({ dateISO:selectedDateISO, title, startHHMM:start, endHHMM:end||'', desc:evtDesc.value.trim(), createdAt:new Date().toISOString() });
      renderCalendar(currentYear,currentMonth);
    });

    // ---------- Requests ----------
    openRequestBtn.addEventListener('click', ()=>{ requestModal.style.display='flex'; reqType.value=''; reqDate.value=toISO(new Date()); reqMessage.value=''; });
    closeRequestModal.addEventListener('click', ()=> requestModal.style.display='none');
    sendRequestBtn.addEventListener('click', async ()=>{
      if(!reqType.value || !reqDate.value || !reqMessage.value.trim()){ alert('All fields required'); return; }
      await addRequest({ type:reqType.value, dateISO:reqDate.value, message:reqMessage.value.trim(), createdAt:new Date().toISOString(), status:'open' });
      requestModal.style.display='none';
      renderCalendar(currentYear,currentMonth);
    });

    function openRequestView(id){
      loadRequests().then(all=>{
        const r = all.find(x=>x.id===id);
        if(!r) return alert('Request not found');
        selectedRequestId = r.id;
        requestViewBody.innerHTML = `<strong>${r.type}</strong><div>${r.message}</div>`;
        requestViewModal.style.display='flex';
      });
    }

    markResolvedBtn.addEventListener('click', async ()=>{
      if(!selectedRequestId) return;
      if(confirm('Mark resolved?')) await resolveRequest(selectedRequestId);
      requestViewModal.style.display='none'; selectedRequestId=null;
      renderCalendar(currentYear,currentMonth);
    });

    // ---------- Init ----------
    (function init(){
      const today=new Date(); currentYear=today.getFullYear(); currentMonth=today.getMonth();
      renderCalendar(currentYear,currentMonth);
    })();

    // ---------- Realtime updates ----------
    onEventsChange(()=>renderCalendar(currentYear,currentMonth));
    onRequestsChange(()=>renderCalendar(currentYear,currentMonth));
  })();
  </script>
</body>
</html>
