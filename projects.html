<script>
(function () {
  const ADMIN_USER = 'admin';
  const ADMIN_PASS = 'admin123';

  let isAdmin = false;
  let currentYear, currentMonth;
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  const calendarGrid = document.getElementById('calendarGrid');
  const monthLabel = document.getElementById('monthLabel');
  const prevBtn = document.getElementById('prevMonthBtn');
  const nextBtn = document.getElementById('nextMonthBtn');
  const timelineList = document.getElementById('timelineList');

  const dayModal = document.getElementById('dayModal');
  const dayModalTitle = document.getElementById('dayModalTitle');
  const dayEventsContainer = document.getElementById('dayEventsContainer');
  const formDateLabel = document.getElementById('formDateLabel');
  const adminIndicator = document.getElementById('adminIndicator');

  const evtTitle = document.getElementById('evtTitle');
  const evtStart = document.getElementById('evtStart');
  const evtEnd = document.getElementById('evtEnd');
  const evtDesc = document.getElementById('evtDesc');
  const saveEvtBtn = document.getElementById('saveEvtBtn');
  const closeDayModal = document.getElementById('closeDayModal');

  const adminModal = document.getElementById('adminModal');
  const adminUser = document.getElementById('adminUser');
  const adminPass = document.getElementById('adminPass');
  const loginBtn = document.getElementById('loginBtn');
  const cancelLoginBtn = document.getElementById('cancelLoginBtn');

  let selectedDateISO = null;

  // ---------- Firebase events ----------
  async function loadEvents() {
    const snapshot = await eventsCol.get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  async function saveEvent() {
    if (!isAdmin) { alert('You must be admin to save events.'); return; }
    const title = evtTitle.value.trim();
    const start = evtStart.value;
    const end = evtEnd.value;
    if (!title) { alert('Event needs a title.'); return; }
    if (!start) { alert('Please set a start time.'); return; }
    if (end && end <= start) { alert('End time must be after start time.'); return; }

    const editingId = saveEvtBtn.dataset.editing;
    const data = {
      dateISO: selectedDateISO,
      title,
      startHHMM: start,
      endHHMM: end || '',
      desc: evtDesc.value.trim(),
      createdAt: new Date().toISOString()
    };

    if (editingId) {
      await eventsCol.doc(editingId).set(data);
      delete saveEvtBtn.dataset.editing;
    } else {
      await eventsCol.add(data);
    }

    evtTitle.value = evtStart.value = evtEnd.value = evtDesc.value = '';
    renderCalendar(currentYear, currentMonth);
    renderTimeline();
    refreshDayEvents();
    alert('Saved.');
  }

  async function deleteEvent(id) {
    if (!isAdmin) return;
    await eventsCol.doc(id).delete();
    renderCalendar(currentYear, currentMonth);
    renderTimeline();
    refreshDayEvents();
  }

  // Real-time listener
  eventsCol.onSnapshot(() => {
    renderCalendar(currentYear, currentMonth);
  });

  // ---------- utilities ----------
  function toISO(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function formatDayLabel(iso) {
    const d = new Date(iso + 'T00:00:00');
    return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
  }

  function eventsForDate(dateISO, arr) {
    return arr.filter(e => e.dateISO === dateISO).sort((a,b)=>a.startHHMM.localeCompare(b.startHHMM));
  }

  async function allUpcomingEvents() {
    const todayISO = toISO(new Date());
    const arr = await loadEvents();
    return arr.filter(e => e.dateISO >= todayISO)
              .sort((a,b) => (a.dateISO + a.startHHMM).localeCompare(b.dateISO + b.startHHMM));
  }

  function uid() { return Math.random().toString(36).slice(2,10); }

  // ---------- calendar rendering ----------
  async function renderCalendar(year, month) {
    calendarGrid.innerHTML = '';
    const dayNameEls = dayNames.map(n => {
      const dn = document.createElement('div');
      dn.className='day-name';
      dn.textContent=n;
      calendarGrid.appendChild(dn);
      return dn;
    });

    const allEvts = await loadEvents();

    const first = new Date(year, month, 1);
    const firstWeekday = first.getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();

    for (let i=0;i<firstWeekday;i++) {
      const blank = document.createElement('div');
      blank.className='date-cell';
      blank.style.opacity=0.2;
      calendarGrid.appendChild(blank);
    }

    for (let d=1;d<=daysInMonth;d++) {
      const date = new Date(year, month, d);
      const iso = toISO(date);
      const cell = document.createElement('div');
      cell.className='date-cell';
      cell.dataset.iso = iso;

      const top = document.createElement('div'); top.className='date-top';
      const num = document.createElement('div'); num.className='date-num'; num.textContent=d;
      top.appendChild(num);

      const evts = eventsForDate(iso, allEvts);
      if (evts.length) {
        const b = document.createElement('div'); b.className='badge';
        b.textContent = `${evts.length} event${evts.length>1?'s':''}`;
        top.appendChild(b);
      } else {
        const spacer = document.createElement('div'); spacer.style.minWidth='34px'; top.appendChild(spacer);
      }
      cell.appendChild(top);

      const list = document.createElement('div'); list.className='events-list';
      evts.slice(0,2).forEach(e=>{
        const eEl=document.createElement('div'); eEl.className='evt';
        eEl.textContent=`${e.startHHMM} • ${e.title}`;
        list.appendChild(eEl);
      });
      if (evts.length>2){
        const more=document.createElement('div'); more.className='muted';
        more.textContent=`+${evts.length-2} more...`; more.style.fontSize='12px';
        list.appendChild(more);
      }
      cell.appendChild(list);

      cell.addEventListener('click',()=>{openDayModal(iso, allEvts);});
      calendarGrid.appendChild(cell);
    }

    const monthName = first.toLocaleDateString(undefined, { month: 'long', year:'numeric' });
    monthLabel.textContent = monthName;

    renderTimeline();
  }

  // ---------- timeline ----------
  async function renderTimeline() {
    timelineList.innerHTML='';
    const upcoming = await allUpcomingEvents();
    if (!upcoming.length) {
      timelineList.innerHTML='<div class="muted">No upcoming events.</div>';
      return;
    }
    upcoming.forEach(e=>{
      const item = document.createElement('div'); item.className='item';
      const left = document.createElement('div'); left.innerHTML=`<strong style="color:#fff">${e.title}</strong><div style="font-size:12px;color:#bcd7ff">${formatDayLabel(e.dateISO)}</div>`;
      const right = document.createElement('div'); right.style.textAlign='right';
      const time = document.createElement('div'); time.className='time'; time.textContent=`${e.startHHMM} → ${e.endHHMM || '—'}`;
      right.appendChild(time);
      if (isAdmin){
        const del = document.createElement('button'); del.className='btn'; del.textContent='Delete'; del.style.marginTop='8px'; del.style.background='rgba(255,80,80,0.12)';
        del.addEventListener('click',(ev)=>{ev.stopPropagation(); deleteEvent(e.id);});
        right.appendChild(del);
      }
      item.appendChild(left);
      item.appendChild(right);
      item.addEventListener('click',()=>{openDayModal(e.dateISO);});
      timelineList.appendChild(item);
    });
  }

  // ---------- modals ----------
  function openDayModal(dateISO, allEvts) {
    selectedDateISO=dateISO;
    dayModalTitle.textContent=`Events for ${formatDayLabel(dateISO)}`;
    formDateLabel.textContent=`Add event for ${dateISO}`;
    adminIndicator.textContent=isAdmin?'Admin: editing enabled':'Viewer mode';
    refreshDayEvents();
    saveEvtBtn.disabled=!isAdmin;
    dayModal.style.display='flex';
  }
  function closeDayModalFn(){ dayModal.style.display='none'; evtTitle.value=evtStart.value=evtEnd.value=evtDesc.value=''; }

  async function refreshDayEvents(){
    dayEventsContainer.innerHTML='';
    const evts = eventsForDate(selectedDateISO, await loadEvents());
    if(!evts.length){
      dayEventsContainer.innerHTML='<div class="muted">No events on this day.</div>'; return;
    }
    evts.forEach(e=>{
      const wrap=document.createElement('div'); wrap.style.marginBottom='8px';
      const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent=`${e.startHHMM} • ${e.title}`;
      const desc=document.createElement('div'); desc.style.fontSize='13px'; desc.style.color='#cfe0ff'; desc.textContent=e.desc||'';
      wrap.appendChild(title); wrap.appendChild(desc);
      if(isAdmin){
        const row=document.createElement('div'); row.style.marginTop='6px'; row.style.display='flex'; row.style.gap='8px';
        const edit=document.createElement('button'); edit.className='btn'; edit.textContent='Edit';
        const del=document.createElement('button'); del.className='btn'; del.textContent='Delete'; del.style.background='rgba(255,80,80,0.12)';
        edit.addEventListener('click',()=>{populateFormForEdit(e);});
        del.addEventListener('click',()=>{if(confirm('Delete event?')) deleteEvent(e.id);});
        row.appendChild(edit); row.appendChild(del);
        wrap.appendChild(row);
      }
      dayEventsContainer.appendChild(wrap);
    });
  }

  function populateFormForEdit(evt){
    selectedDateISO=evt.dateISO;
    evtTitle.value=evt.title;
    evtStart.value=evt.startHHMM;
    evtEnd.value=evt.endHHMM||'';
    evtDesc.value=evt.desc||'';
    saveEvtBtn.dataset.editing=evt.id;
  }

  // ---------- admin login ----------
  function openAdminModal(){ adminUser.value=''; adminPass.value=''; adminModal.style.display='flex'; }
  function closeAdminModal(){ adminModal.style.display='none'; }
  function attemptLogin(){
    if(adminUser.value.trim()===ADMIN_USER && adminPass.value===ADMIN_PASS){
      isAdmin=true;
      closeAdminModal();
      renderTimeline();
      alert('Admin unlocked.');
    } else { alert('Bad credentials.'); }
  }

  // ---------- navigation ----------
  prevBtn.addEventListener('click',()=>{currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--;} renderCalendar(currentYear,currentMonth);});
  nextBtn.addEventListener('click',()=>{currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++;} renderCalendar(currentYear,currentMonth);});

  closeDayModal.addEventListener('click',closeDayModalFn);
  saveEvtBtn.addEventListener('click',saveEvent);
  loginBtn.addEventListener('click',attemptLogin);
  cancelLoginBtn.addEventListener('click',closeAdminModal);

  document.querySelectorAll('.modal-backdrop').forEach(mb=>{
    mb.addEventListener('click',(e)=>{if(e.target===mb) mb.style.display='none';});
  });

  window.addEventListener('keydown',(e)=>{if(e.shiftKey && e.code==='KeyQ') openAdminModal();});
  window.addEventListener('keydown',(e)=>{if(e.key==='Escape'){dayModal.style.display='none'; adminModal.style.display='none';}});

  // ---------- initialize ----------
  (function init(){
    const today=new Date();
    currentYear=today.getFullYear(); currentMonth=today.getMonth();
    renderCalendar(currentYear,currentMonth);
  })();

})();
</script>
